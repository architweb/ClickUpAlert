name: "Send ClickUp Notification Action"

description: "Fetches commit history (if possible) and sends a notification to ClickUp."

branding:
  icon: "bell"
  color: "orange"

inputs:
  clickup_api_token:
    description: "ClickUp API Token"
    required: true
  clickup_workspace_id:
    description: "ClickUp Workspace ID"
    required: true
  clickup_channel_id:
    description: "ClickUp Channel ID"
    required: true
  clickup_project_name:
    description: "ClickUp Project Name for the message"
    required: true
  show_fetch_duration:
    description: "Show duration information in the notification"
    required: false
    default: "true"
  show_changelog_commits:
    description: "Show changelog commits in the notification"
    required: false
    default: "true"
  full_commit_message:
    description: "Use the full commit message instead of the first line"
    required: false
    default: "true"

runs:
  using: "composite"
  steps:
    - name: Set Environment Variables
      shell: bash
      run: |
        echo "CLICKUP_API_TOKEN=${{ inputs.clickup_api_token }}" >> $GITHUB_ENV
        echo "CLICKUP_WORKSPACE_ID=${{ inputs.clickup_workspace_id }}" >> $GITHUB_ENV
        echo "CLICKUP_CHANNEL_ID=${{ inputs.clickup_channel_id }}" >> $GITHUB_ENV
        echo "CLICKUP_PROJECT_NAME=${{ inputs.clickup_project_name }}" >> $GITHUB_ENV
        echo "GITHUB_TOKEN=${{ github.token }}" >> $GITHUB_ENV
        echo "OWNER=$GITHUB_REPOSITORY_OWNER" >> $GITHUB_ENV
        echo "REPO_NAME=$(echo "$GITHUB_REPOSITORY" | cut -d '/' -f 2)" >> $GITHUB_ENV
        echo "BRANCH_NAME=$GITHUB_REF_NAME" >> $GITHUB_ENV
        echo "CURRENT_SHA=$GITHUB_SHA" >> $GITHUB_ENV
        echo "TRIGGERING_ACTOR=$GITHUB_ACTOR" >> $GITHUB_ENV
        echo "RUN_ID=$GITHUB_RUN_ID" >> $GITHUB_ENV
        echo "REPO=$GITHUB_REPOSITORY" >> $GITHUB_ENV
        echo "FULL_COMMIT_MESSAGE=${{ inputs.full_commit_message }}" >> $GITHUB_ENV

    - name: ⏱️ Fetch Duration
      id: duration
      if: ${{ inputs.show_fetch_duration == 'true' }}
      uses: ./steps/fetch-duration

    - name: 📝 Fetch Commits
      id: commits
      if: ${{ inputs.show_changelog_commits == 'true' }}
      uses: ./steps/fetch-commits
      with:
        full_commit_message: ${{ inputs.full_commit_message }}

    - name: 📢 Send ClickUp Notification
      uses: ./steps/send-notification
      with:
        clickup_api_token: ${{ inputs.clickup_api_token }}
        clickup_workspace_id: ${{ inputs.clickup_workspace_id }}
        clickup_channel_id: ${{ inputs.clickup_channel_id }}
        clickup_project_name: ${{ inputs.clickup_project_name }}
        formatted_duration: ${{ inputs.show_fetch_duration == 'true' && steps.duration.outputs.formatted_duration || 'unknown' }}
        commit_file: ${{ inputs.show_changelog_commits == 'true' && steps.commits.outputs.commit_file || '' }}
